---

- name: download mariadb
  get_url:
    url:  https://downloads.mariadb.org/f/mariadb-10.1.22/source/mariadb-10.1.22.tar.gz?serve
    dest: /tmp/mariadb.tar.gz

- name: uncompress mariadb
  unarchive:
    src: /tmp/mariadb.tar.gz
    dest: /tmp
    copy: no

- name: install packages needed to build mariadb
  apt:
    name: "{{item}}"
    state: present
    update_cache: yes
    install_recommends: no
  with_items:
    - bison
    - make
    - cmake
    - g++
    - gcc
    - git
    - libaio-dev
    - libcurl4-gnutls-dev
    - libevent-dev
    - libgnutls28-dev
    - libjemalloc-dev
    - libncurses-dev
    - libxml2-dev
    - zlib1g-dev

- name: configure the mariadb build
  shell: cmake . -DBUILD_CONFIG=mysql_release
  args:
    chdir: /tmp/mariadb-10.1.22

- name: compile mariadb
  shell: (time -p make) > /tmp/compiler.log 2>&1
  args:
    executable: /bin/bash
    chdir: /tmp/mariadb-10.1.22

- name: retrieve log
  fetch:
    src: /tmp/compiler.log
    dest: ../logs/{{inventory_hostname}}/compiler.log
    flat: yes

- name: remove mariadb files
  file:
    path: /tmp/test
    state: absent
  with_items:
    - /tmp/mariadb-10.1.22
    - /tmp/mariadb.tar.gz

- name: remove installed packages
  apt:
    name: "{{item}}"
    autoremove: yes
    purge: yes
    state: absent
  with_items:
    - bison
    - make
    - cmake
    - g++
    - gcc
    - git
    - libaio-dev
    - libcurl4-gnutls-dev
    - libevent-dev
    - libgnutls28-dev
    - libjemalloc-dev
    - libncurses-dev
    - libxml2-dev
    - zlib1g-dev
